---
layout:     post
title:      Retrofit工作原理
subtitle:   Retrofit与okhttp关系
date:       2019-12-20
author:     BY
header-img: img/post-bg-BJJ.jpg
catalog: true
tags:
    - BJJ
---

### 目录

- okhttp 与 apache http
- okhttp工作流程
- Retrofit使用方式
- Retrofit与okhttp



## okhttp 与 apache HttpClient

OkHttp作为square公司出品的一个网络请求框架，目前较为流行的网络框架。

OkHttp 特点
1. 设计和实现的首要目标是高效;
2. OkHttp 提供了对最新的 HTTP 协议版本 HTTP/2 和 SPDY 的支持;
3. 同一个主机发出的所有请求都可以共享相同的套接字连接;
4. OkHttp 会使用连接池来复用连接以提高效率;
5. 当网络出现问题时，OkHttp 会自动重试一个主机的多个 IP 地址;
6. OkHttp 也提供了对 HTTP 响应的缓存机制，可以避免不必要的网络请求.

打进冷宫的HttpClient
1. 版本多，兼容差，api更新慢，文档维护差，程序员们人微言轻，还得用
2. 被Google抛弃，打进冷宫

## okhttp工作流程

OKHttp是一款高效的HTTP客户端，其核心主要有路由、连接协议、拦截器、代理、安全性认证、连接池以

及网络适配，拦截器主要是指添加，移除或者转换请求或者回应的头部信息，

OKHttp3总流程图如下：

![流程图](https://images2018.cnblogs.com/blog/809143/201808/809143-20180816162138233-707076029.png)

使用示例
```java
   public void testOKHttp() {
           try {
               OkHttpClient client = new OkHttpClient();
               Request request = new Request.Builder()
                       .get()
                       .url("http://c3.*.srv/panel/api/v1/articleapi/getPushModel?compId=13816245")
                       .build();
               Response response = client.newCall(request).execute();
               System.out.println("Server: " + response.body().string());
           } catch (Exception e) {
               e.printStackTrace();
           }
       }
```
在使用示例中，newCall会创建一个新的Call,并加上监听器，调用execute方法时才开始工作

```java
   /**
   * Prepares the {@code request} to be executed at some point in the future.
   */
    
   RealCall newRealCall(OkHttpClient client, Request originalRequest, boolean forWebSocket) {
       // 加一个事件监听，后续有用.
       RealCall call = new RealCall(client, originalRequest, forWebSocket);
       call.eventListener = client.eventListenerFactory().create(call);
       return call;
   }
     
   @Override 
   public Response execute() throws IOException {
         //...
         eventListener.callStart(this);
         try {
           // 将call放入队列
           client.dispatcher().executed(this);
           // 拦截器链条
           Response result = getResponseWithInterceptorChain();
           //...
           return result;
           //...
         } finally {
           client.dispatcher().finished(this);
         }
   }
```
拦截器贯穿在okhhtp的整个请求中
观察，修改以及可能短路的请求输出和响应请求的回来
主要是针对Request和Response的链式切面处理
每个拦截器的处理结果向下传递，直到最后一个拦截
```java
   Response getResponseWithInterceptorChain() throws IOException {
     // Build a full stack of interceptors.
     List<Interceptor> interceptors = new ArrayList<>();
     // 用户自己添加的拦截器，在最外层
     interceptors.addAll(client.interceptors());
     // 重试拦截器，重试那些失败或者redirect的请求,在这个拦截器里会创建StreamAllocation连接
     interceptors.add(retryAndFollowUpInterceptor);
     // 请求之前对响应头做了一些检查，并添加一些头，然后在请求之后对响应做一些处理（gzip解压or设置cookie）
     interceptors.add(new BridgeInterceptor(client.cookieJar()));
     // 缓存拦截器，根据用户是否设置缓存来工作
     interceptors.add(new CacheInterceptor(client.internalCache()));
     // 连接拦截器，复用连接池中的连接,利用StreamAllocation寻找连接
     interceptors.add(new ConnectInterceptor(client));
     if (!forWebSocket) {
       interceptors.addAll(client.networkInterceptors());
     }
     // 网络拦截器
     interceptors.add(new CallServerInterceptor(forWebSocket));
 
     Interceptor.Chain chain = new RealInterceptorChain(interceptors, null, null, null, 0,
         originalRequest, this, eventListener, client.connectTimeoutMillis(),
         client.readTimeoutMillis(), client.writeTimeoutMillis());
 
     return chain.proceed(originalRequest);
   }
```
拦截器按照顺序嵌套执行，第一个拦截器要等待第二个拦截器返回结果，并处理，以此内推。

okhttp的一大特点是可以使用连接池，所以我们不可避免要看看这个特性

###  okhttp 连接池

okhttp通过连接池来减小响应延迟。okhttp会与服务器建立连接，
并将socket的io封装到HttpStream（发送请求和接收response）中，这些都在ConnectInterceptor中完成。

```java
HttpCodec httpCodec = streamAllocation.newStream(client, chain, doExtensiveHealthChecks);

public class StreamAllocation {
    private RealConnection findConnection(int connectTimeout, int readTimeout, int writeTimeout,
          int pingIntervalMillis, boolean connectionRetryEnabled) throws IOException {
        ...
        synchronized (connectionPool) {
            ...
          // Attempt to use an already-allocated connection. We need to be careful here because our
          // already-allocated connection may have been restricted from creating new streams.
          if (result == null) {
            // Attempt to get a connection from the pool.
            // 这是个遍历过程：遍历匹配内容池已有socket的address.url().host()
            Internal.instance.get(connectionPool, address, this, null);
            if (connection != null) {
              foundPooledConnection = true;
              result = connection;
            } else {
              selectedRoute = route;
            }
          }
        }
        ...
        if (result != null) {
          // If we found an already-allocated or pooled connection, we're done.
          return result;
        }
    
        if (selectedRoute == null) {
              selectedRoute = routeSelector.next();
              result = new RealConnection(connectionPool, selectedRoute);
        }
        
        // Do TCP + TLS handshakes. This is a blocking operation.
        result.connect(connectTimeout, readTimeout, writeTimeout, address.connectionSpecs(),
                        connectionRetryEnabled);
        
        // 添加进线程池
        synchronized (connectionPool) {
              Internal.instance.put(connectionPool, newConnection);
        }
        
        eventListener.connectionAcquired(call, result);
        return result;
      }
    
}

```


### 一个假设

我知道你还不相信我，所以我会用一个例子来说明我的观点。让我们来看看使用两个战士 Steve 和 JoJo 的假想情景。

#### Steve:

Steve 5岁开始学习柔术，由马塞洛·加西亚，拉法·门德斯和瑞克森·格雷西执教。它学会了他们所有的技巧，并且吸收了他们所有关于压力，时间和人体力学的智慧。他在接下来的13年里每周训练6天。

18岁，体重200磅的 Steve 击败了所有对手取得了 [IBJJF（国际巴西柔术联合会](https://en.wikipedia.org/wiki/International_Brazilian_Jiu-Jitsu_Federation)）世界锦标赛的棕色带中量级冠军，并且立即被授予黑带。第二年，在对战拥有绝对黑带实力的 Buchecha（开头照片中的人）的决赛中，用了一个飞身十字固在13秒内降服了他。

#### JoJo：

JoJo 是一个10岁的银背大猩猩。他体重400磅。他从未接受过柔术或其他武术的训练。

#### 一决胜负：

假设 JoJo 与 Steve 展开一场柔术规则的比赛。

你认为谁会赢得这场比赛？如果你认为 Steve 会用他的“无敌技巧”击败 JoJo，那么你就是妄想。（此外，你可以用 [点穴](https://en.wikipedia.org/wiki/Dim_Mak_Records) 试试~）

JoJo 的**体格**与**力量**优势根本无法用技术来克服。

![你可以知道世界上所有的柔术运动，但是你不会打败JoJo。](http://mjrnxewya3t1in23ybpwjw59.wpengine.netdna-cdn.com/wp-content/uploads/gorilla.jpg)

### 真实的例子

好吧，上面的例子非常不切实际，根本不会发生。但是，我可以举一些我身边的例子：

#### 例子1:

在2013年，我亲眼目睹了世界冠军中，一位黑带女性与体重相同的紫色带男性的比赛，他们在一个开放的垫子上打成一片。这个女人一点机会都没有。她在6分钟内拍垫近十次。

那么现在是因为“女人不擅长柔术”还是因为“男人比女人好”呢？当然不是。这只是一个简单的力量问题。这位男性拥有更高的睾酮水平，因此拥有更强大的结缔组织和更多的肌肉。

#### 例子2:

我有一个朋友身高 1.95m，重达 300磅（136kg），是一个前NCAA中后卫球员。同时他也是柔术棕色腰带。他可以（而且经常）很容易地只用一只手臂将我从地面上抬起。当我们滚动时他绝对砸我，这时候基本上我是无能为力的。

这是否因为他的技术比我好？当然不是。我的训练的时间比他更长，训练频率和强度要高得多。这是因为他比我更高，更大，更强壮。

#### 例子3:

我的正常体重大约是203磅（92kg）。有时，由于各种原因，包括力量训练计划，肌酸周期或假日过度放纵，可能会高达218甚至220磅。

因为我一直在垫子上呆着，所以我可以敏锐的察觉到体重对于柔术的影响。我可以直接告诉你：你越重，对抗越轻松。我可以更轻松的控制体重较轻的对手，并且能对抗更长的时间。

### 这个神话是从哪里来的？

#### 传统武术的胡扯

这个误解也是传统武术的骗人的精髓所在。告诉一个弱小的人学习了某种武术，他就轻松可以击败比他高大，更强壮的坏人。

在20世纪，一个巨大的产业就建立在这个基础之上，各种乱七八糟的武术系统被包装并推给了好骗的西方人。尽管MMA中的柔术技术帮助清除了许多武术的骗局，但现在仍然受到影响。


#### 柔术课的结构

还有一部分原因是由于柔术学院商业模式的本质。虽然柔术比赛竞争激烈，但是现在的柔术学院通常还只是围绕着`技术动作`和`实战对抗`这两个方面进行教学和训练。因此，早期的先驱者重视身体训练，这是有道理的。

乔治·圣皮埃尔的教练Firhas Zahabi曾经对我说过。“随着柔术学院商业化的推广，我们看到了很多必要的体能训练消失了。”他说的对，在绝大多数的柔术学院中，体能训练并不被重视。当然，你也可以做一些跳跃俯卧撑和俯卧撑作为热身的一部分，但这还远远不够。看看拳击手和摔跤手。体能训练往往是他们训练的最重要的组成部分，而对抗往往是花时间最小的一个。

#### 罗伊斯·格雷斯 与 UFC

罗伊斯·格雷西（Royce Gracie）在 UFC 早期的比赛中的惊人表现导致了一些人相信技术确实是无敌的。在我看来，罗伊斯赢了，因为他打的比赛看起来像这样：

> **斗士A（中等属性+强大的技术）> 斗士B（伟大的属性+没有技术）**

由于第二代 MMA 斗士的的属性已经改变，因为家伙们已经开始学习柔术了。比赛开始更像这样：

> **斗士A（中等属性+强大技术）≥ 斗士B（强大属性+一点点技巧）**

在如今的 MMA 比赛中，我们经常看到的情况是这样的：

> **斗士A（卓越的属性+伟大的技术）> 斗士B（伟大的属性+伟大的技术）**

#### 杠杠原理的迷惑

杠杠原理能成倍加强力量，但不是力量的来源。当然，杠杠原理能帮你能更有效的利用力量，但没有力量来源，这个杠杠力也不复存在。这就是‘柔术’中‘杠杠原理’这个概念的迷惑性。

尽管可能会有人告诉你，没有人能为柔术添加杠杠作用。但是一些聪明的运动员及教练确实能够准确的找到杠杠的支点，并且使用的力量来完成动作，效果惊人。

### 好消息

好消息是就算你只进行柔术对抗训练也能自然而然的提升你的体能，尽管这个提升有局限性并且基因决定了你的体能极限（抱歉，就是这样），而通过科学而且集中体能训练可以大幅度提升你的体能。

同时，体型小的训练者并不是总是处于劣势。相对力量会随着体型的增加而减小。所以假设其他条件相同的情况下，一个体重比你大20%的对手，力量并不会比你大20%，通常这个值会是12%~15%。这就意味着那些拥有惊人身体的小个子训练者通常会扳平体型的劣势，有时候甚至还会反超。

最后一个就是力量的增长也会随着年龄的增长而称下降的趋势，并在年老的时候就维持不变了。“人的力量就是这么真实”。



### 如何变得更强

#### 检查你的激素水平

如果你是一个男性柔术运动员，我建议你去内分泌专家那检查你的激素水平。如果你的睾丸酮激素水平过低，不管你如何训练，你的身体素质都不会有较大的提升。一个好医生会建议你使用多种补剂和药品来解决这个问题。

#### 体操

总体来说，拥有了功能性力量与身体控制能力，你将很难被击败。如果让我在力量训练之外再挑选一个最为柔术的赋值训练，那就是体操了。

#### 攀岩

另一项能直接对柔术的运动表现及其力量提升极大的运动就是攀岩了，尤其是握力。

#### 举重

举重对运动表现的提升不是通过几组二头弯举或者卧推就可以的，那是健身。你需要在专业教练的指导下练习奥运举和力量举（例如挺举，深蹲）。

### 你该怎么做

提高柔术水平不仅仅是提升柔术技术。我喜欢柔术的技术，它是那样的直接有效，令人着迷。如果你想在道垫上降服对手，高质量的动作是必不可少的。但这还不够。你可以在[这篇文章](http://www.jiujitsubrotherhood.com/brazilian-jiu-jitsu-tips-a-c-t-model/)中找到答案。

真正的武术家是一个在各个方面力精益求精的人。这包括变得更加强壮。如果你想成为顶级的柔术家，将你的体能提升到极限是你的必修课。